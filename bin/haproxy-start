#!/usr/bin/env bash

if ! ls | grep bin >/dev/null; then
	cd ..
	if ! ls | grep bin >/dev/null; then
		echo 'Please run in project root directory!'
		exit 1
	fi
fi

docker build -t my-haproxy -f Dockerfile_haproxy .
docker run -it --rm --name haproxy-syntax-check my-haproxy haproxy -c -f haproxy.cfg

# if the syntax is valid, build the new HAProxy container
if [ $? -eq 0 ]; then
	docker stop my-running-haproxy
	docker rm my-running-haproxy
	docker run -d -p 8000:80 --name my-running-haproxy my-haproxy -f haproxy.cfg
fi
