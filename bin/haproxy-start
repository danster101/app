#!/usr/bin/env bash

if ! ls | grep bin >/dev/null; then
	cd ..
	if ! ls | grep bin >/dev/null; then
		echo 'Please run in project root directory!'
		exit 1
	fi
fi

if docker-compose ps -q web >/dev/null 2>&1; then

	regex_inspect='"IPAddress": "([0-9.]+)",'
	INSPECT="$(docker inspect $(docker-compose ps -q web))"
	if [[ "$INSPECT" =~ $regex_inspect ]]; then
		ip="${BASH_REMATCH[1]}"

		docker build --build-arg webip="$ip" -t my-haproxy -f Dockerfile_haproxy .
		docker run -it --rm --name haproxy-syntax-check my-haproxy haproxy -c -f haproxy.cfg

		# if the syntax is valid, build the new HAProxy container
		if [ $? -eq 0 ]; then
			docker stop my-running-haproxy 2>/dev/null
			docker rm my-running-haproxy 2>/dev/null
			docker run -d -p 8000:80 --name my-running-haproxy my-haproxy -f haproxy.cfg
		fi
	else
		echo 'Could not get IP address for the web container'
	fi
else
	echo 'Make sure the web container is running (bin/start) before starting HAProxy.'
fi
